<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ­´å²å¹´å·ãƒ»çœŸå‰£å‹è²  & æš—è¨˜ã‚«ãƒ¼ãƒ‰</title>
    <style>
        :root {
            --primary: #d32f2f;
            --hp-fill: #4caf50;
            --accent: #ff9800;
            --panel-bg: rgba(0, 0, 0, 0.95);
            --rank-s: #ffd700;
            --rank-a: #ff4081;
            --rank-b: #4caf50;
            --rank-c: #2196f3;
            --rank-d: #9e9e9e;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            font-family: 'Hiragino Mincho ProN', serif;
            background-color: #000; margin: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100dvh; overflow: hidden; color: #eee;
            user-select: none; -webkit-user-select: none;
        }
        #main-wrapper {
            width: 100%; max-width: 450px; height: 100%;
            background: linear-gradient(to bottom, #1a2a3a, #000);
            position: relative; display: flex; flex-direction: column;
        }

        /* å…±é€šãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .overlay-screen {
            position: absolute; inset: 0; background: var(--panel-bg);
            z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .select-btn {
            background: #333; color: white; border: 2px solid #555;
            padding: 18px 5px; font-size: 1.1rem; border-radius: 8px; font-family: inherit;
            cursor: pointer; position: relative;
        }
        .select-btn:active { background: var(--primary); border-color: #fff; }
        .full-width { grid-column: span 2; background: #442222; }

        .badge {
            position: absolute; top: -10px; right: -10px;
            background: var(--primary); color: #fff; border-radius: 50%;
            width: 28px; height: 28px; font-size: 0.8rem; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .quit-btn {
            background: #333; border: 1px solid #666; color: #ccc;
            padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;
        }
        .quit-btn:active { background: #666; color: #fff; }

        /* ãƒãƒˆãƒ«UI */
        .status-bar {
            flex: 0 0 65px; display: flex; justify-content: space-between;
            align-items: center; padding: 5px 15px; background: rgba(0,0,0,0.5);
        }
        .hp-container { width: 40%; }
        .hp-bar { 
            height: 22px; background: #222; border: 2px solid #fff; 
            border-radius: 11px; overflow: hidden;
        }
        .hp-fill { height: 100%; width: 100%; background: var(--hp-fill); transition: width 0.3s; }
        .label { font-size: 12px; font-weight: bold; margin-bottom: 2px; display: block; }
        #battle-stage { flex: 0 0 100px; position: relative; display: flex; justify-content: center; align-items: flex-end; }
        #enemy-samurai {
            width: 100px; height: 100px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50 5 Q40 5 35 15 L40 25 L30 35 Q20 55 30 95 L70 95 Q80 55 70 35 L60 25 L65 15 Q60 5 50 5 Z" fill="black"/></svg>') no-repeat bottom center;
            background-size: contain; animation: sway 4s ease-in-out infinite;
        }
        @keyframes sway { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        #slash {
            position: absolute; top: 40%; left: 0; width: 0%; height: 8px;
            background: #fff; box-shadow: 0 0 20px 8px #fff; transform: rotate(-15deg); z-index: 10;
        }
        .slash-anim { animation: slash-effect 0.4s ease-out forwards; }
        @keyframes slash-effect { 0% { width: 0%; opacity: 1; } 100% { width: 100%; opacity: 0; } }
        .ui-mid { flex: 0 0 auto; background: rgba(0,0,0,0.7); padding: 10px 15px; text-align: center; }
        #timer-gauge { width: 100%; height: 8px; background: #222; margin-bottom: 10px; border-radius: 4px; }
        #timer-fill { width: 100%; height: 100%; background: var(--accent); border-radius: 4px; }
        #event-name { 
            font-size: 1.4rem; font-weight: bold; color: #fff; margin-bottom: 4px; 
            min-height: 3.2rem; display: flex; align-items: center; justify-content: center;
            font-size: clamp(1rem, 4vw, 1.4rem);
        }
        #hint-text { color: var(--accent); font-size: 1.1rem; font-weight: bold; height: 1.4rem; margin-bottom: 5px; opacity: 0; }
        #input-display { font-size: 3rem; font-weight: bold; letter-spacing: 10px; color: #fff; height: 3.5rem; border-bottom: 2px solid #444; margin: 0 40px; }
        .keypad { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: #111; }
        .key {
            background: #444; color: #fff; border: none; border-radius: 12px;
            font-size: 1.8rem; font-weight: bold; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 5px 0 #000;
        }
        .key:active { transform: translateY(4px); box-shadow: none; background: #666; }
        .key.ok { background: var(--primary); font-size: 2rem; box-shadow: 0 5px 0 #600; }
        .key.c { background: #666; }

        /* ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰UI */
        #fc-card { 
            width: 90%; height: 50%; background: #eee; color: #333; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; cursor: pointer; border: 5px solid #888;
            position: relative; margin-bottom: 20px;
        }
        #fc-year { font-size: 5rem; font-weight: bold; margin: 0; }
        #fc-goro { font-size: 1.8rem; color: var(--primary); font-weight: bold; margin: 20px 0; min-height: 2rem; }
        #fc-event { font-size: 1.5rem; font-weight: bold; color: #1a2a3a; text-align: center; }
        #fc-close-btn {
            position: absolute; top: 10px; right: 10px;
            width: 40px; height: 40px; border-radius: 50%;
            background: #ccc; color: #333; border: none; font-size: 1.5rem; font-weight: bold;
            display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 10;
        }
        .fc-actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; width: 90%; }
        .fc-btn { padding: 15px; border-radius: 8px; border: none; color: #fff; font-weight: bold; font-size: 1rem; }

        /* ä¸¦ã³æ›¿ãˆUI */
        #sort-ui { width: 100%; height: 100%; display: flex; flex-direction: column; background: #222; }
        #sort-header { padding: 10px; background: #333; text-align: center; font-weight: bold; color: #fff; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        
        #sort-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px 10px; 
            position: relative; 
            -webkit-overflow-scrolling: touch;
        }
        #sort-container::-webkit-scrollbar { width: 10px; }
        #sort-container::-webkit-scrollbar-track { background: #222; }
        #sort-container::-webkit-scrollbar-thumb { background: #555; border-radius: 5px; border: 1px solid #333; }
        #sort-container::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .sort-item { background: #444; color: #fff; padding: 15px; margin-bottom: 8px; border-radius: 8px; font-size: 1.2rem; font-weight: bold; display: flex; justify-content: center; align-items: center; touch-action: none; border: 2px solid #555; position: relative; box-sizing: border-box; }
        .sort-placeholder { height: 60px; margin-bottom: 8px; border: 2px dashed #777; background: rgba(255, 255, 255, 0.1); border-radius: 8px; }
        .drag-clone { position: fixed; pointer-events: none; z-index: 9999; background: var(--primary); color: #fff; padding: 15px; border-radius: 8px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.8); opacity: 0.9; transform: scale(1.05); display: flex; justify-content: center; align-items: center; border: 2px solid #fff; box-sizing: border-box; }
        .sort-item.invisible { display: none; }
        .sort-item.correct { border-color: #4caf50; background: #1b5e20; }
        .sort-item.wrong { border-color: #f44336; background: #b71c1c; }

        /* åˆ†æUI */
        #analysis-ui { width: 100%; height: 100%; overflow-y: auto; background: #111; padding: 20px; }
        .analysis-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .era-row { display: flex; align-items: center; margin-bottom: 15px; background: #222; padding: 10px; border-radius: 8px; }
        .era-name { width: 60px; font-weight: bold; font-size: 1rem; text-align: center; }
        .era-graph { flex: 1; margin: 0 15px; height: 20px; background: #444; border-radius: 10px; overflow: hidden; position: relative; }
        .era-bar { height: 100%; width: 0%; transition: width 1s; }
        .era-rank { width: 40px; font-size: 1.5rem; font-weight: bold; text-align: center; }
        
        .rank-s { color: var(--rank-s); }
        .rank-a { color: var(--rank-a); }
        .rank-b { color: var(--rank-b); }
        .rank-c { color: var(--rank-c); }
        .rank-d { color: var(--rank-d); }

        #data-transfer-area { margin-top: 30px; padding: 15px; background: #333; border-radius: 8px; }
        textarea { width: 100%; height: 60px; background: #111; color: #fff; border: 1px solid #555; border-radius: 4px; padding: 5px; font-size: 0.8rem; }
        
        .damage-flash { animation: flash-red 0.3s; }
        @keyframes flash-red { 50% { background: rgba(255, 0, 0, 0.6); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="mode-screen" class="overlay-screen">
        <h1 style="color:var(--accent);">ä¿®è¡Œã®é“ã‚’é¸ã¹</h1>
        <div class="btn-grid" style="grid-template-columns: 1fr 1fr; height: auto;">
            <button class="select-btn full-width" style="height:80px; font-size:1.4rem;" onclick="selectMode('battle')">âš”ï¸ ä¾ãƒãƒˆãƒ« (å®Ÿæˆ¦)</button>
            <button class="select-btn" style="height:80px; font-size:1.2rem; background:#2e7d32;" onclick="selectMode('flash')">ğŸ´ æš—è¨˜ã‚«ãƒ¼ãƒ‰</button>
            <button class="select-btn" style="height:80px; font-size:1.2rem; background:#1565c0;" onclick="selectMode('sort')">ğŸ“œ æ™‚ä»£æ•´åˆ—</button>
            <button class="select-btn full-width" style="height:60px; font-size:1.2rem; background:#424242; border-color:#9e9e9e;" onclick="selectMode('analysis')">ğŸ“Š æˆ¦ç¸¾åˆ†æ & ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ</button>
        </div>
        <div style="margin-top:20px; font-size:0.8rem; color:#888;">é€²æ—ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</div>
    </div>

    <div id="era-screen" class="overlay-screen hidden">
        <h2 id="era-title">æ™‚ä»£ã‚’é¸æŠã›ã‚ˆ</h2>
        <div class="btn-grid">
            <button class="select-btn full-width" onclick="selectEra('all')">å…¨æ™‚ä»£</button>
            <button class="select-btn" onclick="selectEra('å¤ä»£')">å¤ä»£<br><span style="font-size:0.8rem">(å¼¥ç”Ÿ~å¹³å®‰)</span></button>
            <button class="select-btn" onclick="selectEra('ä¸­ä¸–')">ä¸­ä¸–<br><span style="font-size:0.8rem">(éŒå€‰~å®¤ç”º)</span></button>
            <button class="select-btn" onclick="selectEra('è¿‘ä¸–')">è¿‘ä¸–<br><span style="font-size:0.8rem">(å®‰åœŸæ¡ƒå±±~æ±Ÿæˆ¸)</span></button>
            <button class="select-btn" onclick="selectEra('è¿‘ä»£')">è¿‘ä»£<br><span style="font-size:0.8rem">(æ˜æ²»~æˆ¦å‰)</span></button>
            <button class="select-btn full-width" onclick="selectEra('ç¾ä»£')">ç¾ä»£<br><span style="font-size:0.8rem">(æˆ¦å¾Œ~ä»¤å’Œ)</span></button>
        </div>
        <button class="select-btn full-width" style="margin-top:20px; background:none; border:none;" onclick="location.reload()">â† æˆ»ã‚‹</button>
    </div>

    <div id="diff-screen" class="overlay-screen hidden">
        <h2>æˆ¦ã„æ–¹ã‚’é¸ã¹</h2>
        <div class="btn-grid">
            <button class="select-btn full-width" onclick="startBattle('normal')">é€šå¸¸å®Ÿæˆ¦<br><span style="font-size:0.8rem">ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ</span></button>
            <button class="select-btn full-width" onclick="startBattle('weak')" style="background:#5d4037; border-color:#d7ccc8;">
                è‹¦æ‰‹å…‹æœ<br><span style="font-size:0.8rem">é–“é•ãˆãŸå•é¡Œã®ã¿</span>
                <div id="weak-badge" class="badge hidden">0</div>
            </button>
        </div>
        <button class="select-btn full-width" style="margin-top:20px; background:none; border:none;" onclick="location.reload()">â† æˆ»ã‚‹</button>
    </div>

    <div id="analysis-ui" class="overlay-screen hidden" style="align-items: stretch; text-align: left;">
        <div class="analysis-header">
            <h2 style="margin:0;">æˆ¦ç¸¾åˆ†æ</h2>
            <button class="quit-btn" onclick="location.reload()">é–‰ã˜ã‚‹</button>
        </div>
        <div id="analysis-container">
            </div>

        <div id="data-transfer-area">
            <h3>ğŸ“² ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ (åˆ¥ç«¯æœ«ã¸)</h3>
            <p style="font-size:0.8rem; color:#aaa;">ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€åˆ¥ã®ç«¯æœ«ã®ã€Œèª­ã¿è¾¼ã¿ã€ã«è²¼ã‚Šä»˜ã‘ã‚‹ã¨ç¶šãã‹ã‚‰éŠã¹ã¾ã™ã€‚</p>
            <textarea id="export-area" readonly onclick="this.select()"></textarea>
            <div style="text-align:right; margin-bottom:10px;">
                <button class="quit-btn" onclick="copyData()">ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>
            <hr style="border:0; border-top:1px solid #555;">
            <p style="font-size:0.8rem; color:#aaa;">åˆ¥ç«¯æœ«ã®ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦èª­ã¿è¾¼ã‚€</p>
            <textarea id="import-area" placeholder="ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
            <button class="select-btn full-width" style="margin-top:10px; font-size:1rem;" onclick="importData()">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
        </div>
        <div style="height:50px;"></div>
    </div>

    <div id="game-ui" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <div class="status-bar">
            <div class="hp-container"><span class="label">è‡ªåˆ†</span><div class="hp-bar"><div id="p-hp" class="hp-fill"></div></div></div>
            <button class="quit-btn" onclick="location.reload()">æ’¤é€€</button>
            <div class="hp-container"><span class="label" style="text-align:right">å®¿æ•µ</span><div class="hp-bar"><div id="e-hp" class="hp-fill"></div></div></div>
        </div>
        <div id="battle-stage"><div id="slash"></div><div id="enemy-samurai"></div></div>
        <div class="ui-mid">
            <div id="timer-gauge"><div id="timer-fill"></div></div>
            <div id="event-name">å‡ºé™£</div>
            <div id="hint-text">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</div>
            <div id="input-display">____</div>
        </div>
        <div class="keypad">
            <button class="key" onclick="tapNum(1)">1</button><button class="key" onclick="tapNum(2)">2</button><button class="key" onclick="tapNum(3)">3</button>
            <button class="key" onclick="tapNum(4)">4</button><button class="key" onclick="tapNum(5)">5</button><button class="key" onclick="tapNum(6)">6</button>
            <button class="key" onclick="tapNum(7)">7</button><button class="key" onclick="tapNum(8)">8</button><button class="key" onclick="tapNum(9)">9</button>
            <button class="key c" onclick="tapClear()">C</button><button class="key" onclick="tapNum(0)">0</button><button class="key ok" onclick="tapOk()">æ–¬</button>
        </div>
    </div>

    <div id="flash-ui" class="overlay-screen hidden" style="background:#1a2a3a;">
        <div id="fc-progress" style="margin-bottom:20px;">0 / 0</div>
        <button id="fc-close-btn" onclick="location.reload()">Ã—</button>
        <div id="fc-card" onclick="nextFcStep()">
            <p id="fc-year">----</p>
            <p id="fc-goro" class="hidden">ã‚´ãƒ­</p>
            <p id="fc-event" class="hidden">å‡ºæ¥äº‹</p>
            <p id="fc-msg" style="font-size:0.8rem; color:#999; margin-top:30px;">ã‚¿ãƒƒãƒ—ã§æ­£è§£ã‚’è¦‹ã‚‹</p>
        </div>
        <div id="fc-actions" class="fc-actions hidden">
            <button class="fc-btn" style="background:#4caf50;" onclick="rateCard('memo')">è¦šãˆãŸ</button>
            <button class="fc-btn" style="background:#2196f3;" onclick="rateCard('normal')">æ™®é€š</button>
            <button class="fc-btn" style="background:#d32f2f;" onclick="rateCard('weak')">è‹¦æ‰‹</button>
        </div>
        <button class="select-btn" style="margin-top:30px;" onclick="location.reload()">ä¿®è¡Œã‚’çµ‚ãˆã‚‹</button>
    </div>

    <div id="sort-ui" class="hidden">
        <div id="sort-header">
            <button class="quit-btn" onclick="location.reload()">ä¸­æ–­</button>
            <span style="font-size:0.9rem;">å¤ãé †ã«ä¸¦ã¹ã‚ˆ</span>
            <button id="sort-check-btn" class="select-btn" style="padding:5px 15px; font-size:0.9rem; background:var(--primary);" onclick="checkSortOrder()">åˆ¤å®š</button>
        </div>
        <div id="sort-container"></div>
    </div>

    <div id="result-screen" class="overlay-screen hidden">
        <h1 id="res-title" style="font-size:3rem;"></h1>
        <p id="res-msg" style="font-size:1.4rem;"></p>
        <button class="key ok" style="padding: 20px 60px; height: auto;" onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
    </div>
</div>

<script src="questions.js"></script>

<script>
    const STORAGE_KEY = 'history_game_v1';
    let userStats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
    // { "id": { w:èª¤ç­”æ•°, s:é€£ç¶šæ­£è§£, f:ãƒ•ãƒ©ãƒƒã‚·ãƒ¥è©•ä¾¡(-1:è¦š, 1:è‹¦) } }

    function getStat(id) {
        if (!userStats[id]) userStats[id] = { w: 0, s: 0, f: 0 };
        return userStats[id];
    }
    function saveStat(id, isCorrect, type = 'battle') {
        const s = getStat(id);
        if (type === 'battle') {
            if (isCorrect) s.s++; else { s.w++; s.s = 0; }
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(userStats));
    }

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();
    function playTone(type, freq, duration, vol = 0.1) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(vol, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
    }
    function playSound(type) {
        switch(type) {
            case 'key': playTone('sine', 800, 0.08, 0.1); break;
            case 'slash': playTone('sawtooth', 600, 0.1, 0.15); setTimeout(() => playTone('square', 300, 0.2, 0.15), 50); break;
            case 'damage': playTone('sawtooth', 100, 0.3, 0.3); playTone('square', 80, 0.3, 0.3); break;
            case 'ok': playTone('sine', 1200, 0.1, 0.1); setTimeout(() => playTone('sine', 1800, 0.2, 0.1), 100); break;
            case 'grab': playTone('triangle', 200, 0.1, 0.2); break;
            case 'pop': playTone('sine', 600, 0.05, 0.05); break;
        }
    }

    let mode = '', selectedEra = '', playerHp = 100, enemyHp = 100;
    let currentIdx = 0, quizList = [], userInput = "", timerInterval, fcStep = 0;
    let damagePerHit = 20; // 1å•ã‚ãŸã‚Šã®ãƒ€ãƒ¡ãƒ¼ã‚¸

    window.onload = function() {
        if (typeof masterData === 'undefined') { alert('ã‚¨ãƒ©ãƒ¼: questions.js ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
        masterData.forEach((d, i) => d.id = i);
    };

    function selectMode(m) { 
        if(audioCtx.state === 'suspended') audioCtx.resume();
        playSound('ok'); mode = m; 
        document.getElementById('mode-screen').classList.add('hidden'); 
        if (mode === 'sort') startSortGame();
        else if (mode === 'analysis') showAnalysis();
        else document.getElementById('era-screen').classList.remove('hidden'); 
    }

    function selectEra(era) {
        playSound('ok'); selectedEra = era;
        document.getElementById('era-screen').classList.add('hidden');
        if (mode === 'battle') { 
            const weakCount = masterData.filter(q => (era === 'all' || q.era === era) && getStat(q.id).w > 0 && getStat(q.id).s < 3).length;
            const badge = document.getElementById('weak-badge');
            badge.innerText = weakCount;
            if(weakCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            document.getElementById('diff-screen').classList.remove('hidden'); 
        } else { startFlash(); }
    }

    // --- åˆ†æ & ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ ---
    function showAnalysis() {
        document.getElementById('analysis-ui').classList.remove('hidden');
        const container = document.getElementById('analysis-container');
        container.innerHTML = "";
        
        // ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        const exportStr = btoa(unescape(encodeURIComponent(JSON.stringify(userStats))));
        document.getElementById('export-area').value = exportStr;

        // ã‚°ãƒ©ãƒ•ç”Ÿæˆ
        const eras = ['å¤ä»£', 'ä¸­ä¸–', 'è¿‘ä¸–', 'è¿‘ä»£', 'ç¾ä»£'];
        eras.forEach(era => {
            const eraQs = masterData.filter(q => q.era === era);
            if(eraQs.length === 0) return;

            // ã‚¹ã‚³ã‚¢è¨ˆç®— (æ­£è§£ç¶™ç¶šã§åŠ ç‚¹ã€è‹¦æ‰‹ã§æ¸›ç‚¹)
            let totalScore = 0;
            eraQs.forEach(q => {
                const s = getStat(q.id);
                let qScore = 50; // åŸºç¤ç‚¹
                if (s.f === -1) qScore += 30; // è¦šãˆãŸ
                if (s.s >= 3) qScore += 20;   // 3é€£ç¶šæ­£è§£
                if (s.f === 1) qScore -= 30;  // è‹¦æ‰‹
                if (s.w > 0) qScore -= Math.min(40, s.w * 10); // èª¤ç­”æ•°ãƒšãƒŠãƒ«ãƒ†ã‚£
                totalScore += Math.max(0, Math.min(100, qScore));
            });
            const avg = Math.round(totalScore / eraQs.length);
            
            // ãƒ©ãƒ³ã‚¯åˆ¤å®š
            let rank = 'D', color = 'var(--rank-d)';
            if (avg >= 90) { rank = 'S'; color = 'var(--rank-s)'; }
            else if (avg >= 75) { rank = 'A'; color = 'var(--rank-a)'; }
            else if (avg >= 60) { rank = 'B'; color = 'var(--rank-b)'; }
            else if (avg >= 40) { rank = 'C'; color = 'var(--rank-c)'; }

            const html = `
            <div class="era-row">
                <div class="era-name">${era}</div>
                <div class="era-graph"><div class="era-bar" style="width:${avg}%; background:${color};"></div></div>
                <div class="era-rank" style="color:${color};">${rank}</div>
            </div>`;
            container.innerHTML += html;
        });
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨
        setTimeout(() => {
            document.querySelectorAll('.era-bar').forEach(el => {
                const w = el.style.width;
                el.style.width = '0%';
                setTimeout(() => el.style.width = w, 50);
            });
        }, 100);
    }

    function copyData() {
        const copyText = document.getElementById("export-area");
        copyText.select();
        document.execCommand("copy");
        alert("ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼åˆ¥ã®ç«¯æœ«ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
    }

    function importData() {
        const input = document.getElementById("import-area").value;
        try {
            const json = decodeURIComponent(escape(atob(input)));
            const parsed = JSON.parse(json);
            if (confirm("ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ")) {
                userStats = parsed;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(userStats));
                alert("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸï¼");
                location.reload();
            }
        } catch (e) {
            alert("ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
        }
    }

    // --- ãƒãƒˆãƒ« ---
    function startBattle(type) {
        playSound('ok'); 
        document.getElementById('diff-screen').classList.add('hidden'); 
        document.getElementById('game-ui').classList.remove('hidden');
        
        let baseList = masterData.filter(q => (selectedEra === 'all' || q.era === selectedEra));
        if (type === 'weak') {
            quizList = baseList.filter(q => { const s = getStat(q.id); return s.w > 0 && s.s < 3; });
            quizList.sort((a, b) => getStat(b.id).w - getStat(a.id).w);
            if (quizList.length === 0) { alert("è‹¦æ‰‹ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ï¼ã¾ãšã¯é€šå¸¸å®Ÿæˆ¦ã¸ã€‚"); location.reload(); return; }
        } else {
            quizList = baseList.sort(() => Math.random() - 0.5);
        }
        
        // æœ€å¤§10å•
        quizList = quizList.slice(0, 10);
        
        // ãƒ€ãƒ¡ãƒ¼ã‚¸è¨ˆç®—: å•é¡Œæ•°ãŒå°‘ãªã„å ´åˆã§ã‚‚å…¨å•æ­£è§£ã§100ä»¥ä¸Šã«ãªã‚‹ã‚ˆã†ã«èª¿æ•´
        if (quizList.length > 0) {
            damagePerHit = Math.max(20, Math.ceil(100 / quizList.length));
        } else {
            damagePerHit = 20;
        }

        playerHp = 100; enemyHp = 100; currentIdx = 0;
        updateHpUI(); showQuestion();
    }
    
    function updateHpUI() {
        document.getElementById('p-hp').style.width = Math.max(0, playerHp) + "%";
        document.getElementById('e-hp').style.width = Math.max(0, enemyHp) + "%";
    }
    function showQuestion() {
        if (playerHp <= 0 || enemyHp <= 0 || currentIdx >= quizList.length) { endGame(); return; }
        userInput = ""; renderInput();
        document.getElementById('input-display').style.color = "#fff";
        document.getElementById('event-name').innerText = quizList[currentIdx].e;
        document.getElementById('hint-text').innerText = quizList[currentIdx].h;
        document.getElementById('hint-text').style.opacity = 0;
        startTimer();
    }
    function startTimer() {
        if(timerInterval) clearInterval(timerInterval);
        let start = Date.now();
        timerInterval = setInterval(() => {
            let ratio = 1 - ((Date.now() - start) / 12000);
            document.getElementById('timer-fill').style.width = Math.max(0, ratio * 100) + "%";
            if (ratio < 0.5) document.getElementById('hint-text').style.opacity = 1;
            if (ratio <= 0) { clearInterval(timerInterval); processResult(false); }
        }, 50);
    }
    function tapNum(n) { playSound('key'); if (userInput.length < 4) { userInput += n; renderInput(); } }
    function tapClear() { playSound('key'); userInput = ""; renderInput(); }
    function renderInput() { document.getElementById('input-display').innerText = userInput || "____"; }
    function tapOk() { if (userInput === "") return; clearInterval(timerInterval); processResult(userInput === quizList[currentIdx].y); }
    
    function processResult(correct) {
        const slash = document.getElementById('slash'), display = document.getElementById('input-display'), container = document.getElementById('main-wrapper');
        saveStat(quizList[currentIdx].id, correct, 'battle');
        if (correct) {
            playSound('slash'); slash.classList.remove('slash-anim'); void slash.offsetWidth; slash.classList.add('slash-anim');
            enemyHp -= damagePerHit; // è¨ˆç®—ã•ã‚ŒãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‹
            display.style.color = "#4caf50";
        } else {
            playSound('damage'); container.classList.add('damage-flash'); setTimeout(() => container.classList.remove('damage-flash'), 300);
            playerHp -= 25; display.style.color = "#f44336"; display.innerText = quizList[currentIdx].y;
        }
        updateHpUI(); setTimeout(() => { currentIdx++; showQuestion(); }, 1300);
    }
    function endGame() {
        clearInterval(timerInterval); document.getElementById('game-ui').classList.add('hidden'); document.getElementById('result-screen').classList.remove('hidden');
        const win = enemyHp <= 0; const lose = playerHp <= 0;
        let title = win ? "å®Œå…¨å‹åˆ©" : (lose ? "æ•—åŒ—" : "ç„¡å¿µ");
        let msg = win ? "æ­´å²ã‚’æ¥µã‚ã—è€…ãªã‚Šï¼" : (lose ? "ä¿®è¡ŒãŒè¶³ã‚Šã¬ã‚ˆã†ã§ã™ãã€‚" : "æ•µã‚’å€’ã—ãã‚Œãªã‹ã£ãŸã€‚ç„¡å¿µã€‚");
        document.getElementById('res-title').innerText = title; document.getElementById('res-msg').innerText = msg;
    }

    // --- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰ ---
    function startFlash() {
        document.getElementById('flash-ui').classList.remove('hidden');
        let baseList = masterData.filter(q => (selectedEra === 'all' || q.era === selectedEra));
        let weightedList = [];
        baseList.forEach(q => {
            const s = getStat(q.id);
            let count = 1;
            if (s.f === -1) { if (Math.random() < 0.1) count = 1; else count = 0; }
            else if (s.f === 1) count = 3;
            for(let i=0; i<count; i++) weightedList.push(q);
        });
        if (weightedList.length === 0) weightedList = baseList;
        quizList = weightedList.sort(() => Math.random() - 0.5);
        currentIdx = 0; showFcCard();
    }
    function showFcCard() {
        if (currentIdx >= quizList.length) { alert("ä¸€é€šã‚Šã®ä¿®è¡Œã‚’çµ‚ãˆã¾ã—ãŸï¼"); location.reload(); return; }
        fcStep = 0; const q = quizList[currentIdx];
        document.getElementById('fc-progress').innerText = `${currentIdx + 1} / ${quizList.length}`;
        document.getElementById('fc-year').innerText = q.y;
        document.getElementById('fc-goro').innerText = q.h;
        document.getElementById('fc-event').innerText = q.e;
        document.getElementById('fc-goro').classList.add('hidden');
        document.getElementById('fc-event').classList.add('hidden');
        document.getElementById('fc-actions').classList.add('hidden');
        document.getElementById('fc-msg').innerText = "ã‚¿ãƒƒãƒ—ã§ã‚´ãƒ­ã‚’è¦‹ã‚‹";
        document.getElementById('fc-msg').classList.remove('hidden');
    }
    function nextFcStep() {
        if (fcStep >= 2) return;
        fcStep++;
        if (fcStep === 1) { playSound('key'); document.getElementById('fc-goro').classList.remove('hidden'); document.getElementById('fc-msg').innerText = "ã‚¿ãƒƒãƒ—ã§ç­”ãˆã‚’è¦‹ã‚‹"; }
        else if (fcStep === 2) { playSound('ok'); document.getElementById('fc-event').classList.remove('hidden'); document.getElementById('fc-actions').classList.remove('hidden'); document.getElementById('fc-msg').classList.add('hidden'); }
    }
    function rateCard(rating) {
        const q = quizList[currentIdx];
        const s = getStat(q.id);
        if (rating === 'memo') s.f = -1; else if (rating === 'normal') s.f = 0; else if (rating === 'weak') s.f = 1;
        saveStat(q.id, true, 'flash');
        playSound('ok'); currentIdx++; showFcCard();
    }

    // --- ä¸¦ã³æ›¿ãˆï¼ˆæ©Ÿèƒ½å¼·åŒ–ç‰ˆï¼‰ ---
    // æ­£è§£ãƒ‡ãƒ¼ã‚¿ï¼ˆä»¤å’Œã¾ã§ï¼‰
    const correctOrder = ["æ—§çŸ³å™¨", "ç¸„æ–‡", "å¼¥ç”Ÿ", "å¤å¢³", "é£›é³¥", "å¥ˆè‰¯", "å¹³å®‰", "éŒå€‰", "å—åŒ—æœ", "å®¤ç”º", "å®‰åœŸæ¡ƒå±±", "æ±Ÿæˆ¸", "æ˜æ²»", "å¤§æ­£", "æ˜­å’Œ", "å¹³æˆ", "ä»¤å’Œ"];
    
    let draggingItem = null;
    let dragClone = null;
    let placeholder = null;
    let dragOffsetY = 0;
    let dragOffsetX = 0; 
    let autoScrollInterval = null; 

    function startSortGame() {
        document.getElementById('sort-ui').classList.remove('hidden');
        // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹ã‚‹
        const shuffled = [...correctOrder].sort(() => Math.random() - 0.5);
        const container = document.getElementById('sort-container');
        container.innerHTML = "";
        shuffled.forEach(era => {
            const div = document.createElement('div');
            div.className = 'sort-item';
            div.innerText = era;
            div.dataset.val = era;
            // å—å‹•çš„ãƒªã‚¹ãƒŠãƒ¼ã§ã¯ãªã„ã“ã¨ã‚’æ˜ç¤º
            div.addEventListener('mousedown', onDragStart);
            div.addEventListener('touchstart', onDragStart, {passive: false});
            container.appendChild(div);
        });
    }

    function onDragStart(e) {
        if(e.target.tagName === 'BUTTON') return;

        // 2æœ¬æŒ‡ä»¥ä¸Šã®æ“ä½œï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ã‚’ã—ãªã„
        if (e.touches && e.touches.length > 1) {
            return; 
        }

        e.preventDefault(); 
        
        const item = e.target.closest('.sort-item');
        if(!item) return;

        playSound('grab');
        if(navigator.vibrate) navigator.vibrate(10);

        draggingItem = item;
        const rect = item.getBoundingClientRect();
        
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        
        dragOffsetY = clientY - rect.top;
        dragOffsetX = clientX - rect.left;

        dragClone = item.cloneNode(true);
        dragClone.className = 'drag-clone';
        dragClone.style.width = rect.width + 'px';
        dragClone.style.height = rect.height + 'px';
        dragClone.style.boxSizing = "border-box"; 
        
        updateClonePosition(clientX, clientY);
        document.body.appendChild(dragClone);

        placeholder = document.createElement('div');
        placeholder.className = 'sort-placeholder';
        placeholder.style.height = rect.height + 'px';
        
        item.parentNode.insertBefore(placeholder, item);
        item.classList.add('invisible');

        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, {passive: false});
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
    }

    function updateClonePosition(x, y) {
        if(dragClone) {
            dragClone.style.top = (y - dragOffsetY) + 'px';
            dragClone.style.left = (x - dragOffsetX) + 'px';
        }
    }

    function onDragMove(e) {
        if (!dragClone) return;
        
        if (e.touches && e.touches.length > 1) {
            onDragEnd(e);
            return;
        }

        e.preventDefault();

        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;

        updateClonePosition(clientX, clientY);
        checkAutoScroll(clientY); 

        const elemBelow = document.elementFromPoint(clientX, clientY);
        if (!elemBelow) return;

        const target = elemBelow.closest('.sort-item');

        if (target && target !== draggingItem && !target.classList.contains('invisible')) {
            const targetRect = target.getBoundingClientRect();
            const middleY = targetRect.top + targetRect.height / 2;

            if (clientY < middleY) {
                if (placeholder.nextElementSibling !== target) {
                    placeholder.parentNode.insertBefore(placeholder, target);
                    playSound('pop');
                }
            } else {
                if (placeholder.previousElementSibling !== target) {
                    placeholder.parentNode.insertBefore(placeholder, target.nextElementSibling);
                    playSound('pop');
                }
            }
        }
    }

    function checkAutoScroll(y) {
        const container = document.getElementById('sort-container');
        const rect = container.getBoundingClientRect();
        const threshold = 60; 
        const speed = 15;     

        if (y < rect.top + threshold) {
            startScroll(-speed);
        } else if (y > rect.bottom - threshold) {
            startScroll(speed);
        } else {
            stopScroll();
        }
    }

    function startScroll(amount) {
        if (autoScrollInterval) return; 
        autoScrollInterval = setInterval(() => {
            const container = document.getElementById('sort-container');
            container.scrollTop += amount;
        }, 20); 
    }

    function stopScroll() {
        if (autoScrollInterval) {
            clearInterval(autoScrollInterval);
            autoScrollInterval = null;
        }
    }

    function onDragEnd(e) {
        stopScroll(); 

        document.removeEventListener('mousemove', onDragMove);
        document.removeEventListener('touchmove', onDragMove);
        document.removeEventListener('mouseup', onDragEnd);
        document.removeEventListener('touchend', onDragEnd);

        if (draggingItem && placeholder) {
            placeholder.parentNode.insertBefore(draggingItem, placeholder);
            placeholder.remove();
            draggingItem.classList.remove('invisible');
        }

        if (dragClone) {
            dragClone.remove();
            dragClone = null;
        }

        draggingItem = null;
        placeholder = null;
        playSound('key');
    }

    function checkSortOrder() {
        const items = document.querySelectorAll('#sort-container .sort-item');
        let correctCount = 0;
        
        items.forEach((item, idx) => {
            if (item.dataset.val === correctOrder[idx]) {
                item.classList.add('correct');
                item.classList.remove('wrong');
                correctCount++;
            } else {
                item.classList.add('wrong');
                item.classList.remove('correct');
            }
        });

        if (correctCount === correctOrder.length) {
            playSound('slash');
            alert("è¦‹äº‹ï¼æ­´å²ã®æµã‚Œã‚’å®Œå…¨ã«ç†è§£ã—ã¦ã„ã¾ã™ï¼");
        } else {
            playSound('damage');
        }
    }
</script>
</body>
</html>