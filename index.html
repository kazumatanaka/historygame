<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ê≠¥Âè≤Âπ¥Âè∑„ÉªÁúüÂâ£ÂãùË≤†</title>
    <style>
        :root {
            --primary: #d32f2f;
            --hp-fill: #4caf50;
            --accent: #d4af37;
            --panel-bg: rgba(15, 15, 15, 0.95);
            --text: #f0f0f0;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            font-family: "Yu Mincho", "YuMincho", "Hiragino Mincho ProN", serif;
            background-color: #050505; margin: 0;
            display: flex; justify-content: center; align-items: center;
            height: 100dvh; overflow: hidden; color: var(--text);
        }
        #main-wrapper {
            width: 100%; max-width: 450px; height: 100%;
            background: radial-gradient(circle at center, #2c1a1a 0%, #000 100%);
            position: relative; display: flex; flex-direction: column;
            border-left: 1px solid #333; border-right: 1px solid #333;
        }
        .overlay-screen {
            position: absolute; inset: 0; background: var(--panel-bg);
            z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 30px; text-align: center;
        }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .select-btn {
            background: #222; color: var(--text); border: 1px solid var(--accent);
            padding: 15px 5px; font-size: 1rem; border-radius: 4px; font-family: inherit;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .select-btn:active { background: var(--accent); color: #000; }
        .full-width { grid-column: span 2; }
        .main-menu-btn { height: 80px; font-size: 1.3rem; font-weight: bold; border-width: 2px; }
        .status-bar { flex: 0 0 70px; display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        .hp-container { width: 42%; }
        .hp-bar { height: 14px; background: #222; border: 1px solid var(--accent); border-radius: 7px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; background: var(--hp-fill); transition: width 0.4s; }
        #battle-stage { flex: 0 0 120px; position: relative; display: flex; justify-content: center; align-items: flex-end; }
        #enemy-samurai { width: 100px; height: 100px; background: #111; border: 1px solid #333; border-radius: 50%; }
        #slash { position: absolute; top: 50%; left: -10%; width: 0%; height: 4px; background: #fff; box-shadow: 0 0 15px #fff; transform: rotate(-20deg); }
        .slash-anim { animation: slash-effect 0.3s ease-out forwards; }
        @keyframes slash-effect { 0% { width: 0%; opacity: 1; } 100% { width: 120%; opacity: 0; } }
        .ui-mid { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 20px; }
        #timer-gauge { width: 100%; height: 4px; background: #222; margin-bottom: 10px; }
        #timer-fill { width: 100%; height: 100%; background: var(--accent); }
        #event-name { font-size: 1.4rem; font-weight: bold; min-height: 3.5rem; margin-bottom: 10px; }
        #input-display { font-size: 3.5rem; font-weight: bold; border-bottom: 2px solid var(--accent); text-align: center; margin-bottom: 20px; letter-spacing: 5px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 15px; background: #000; }
        .key { background: #1a1a1a; color: #fff; border: 1px solid #333; border-radius: 8px; font-size: 1.5rem; padding: 15px 0; }
        .key:active { background: var(--accent); }
        #fc-card { width: 100%; height: 300px; background: #eee; color: #111; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #fc-year { font-size: 4rem; font-weight: bold; margin: 0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="main-wrapper">
    <div id="mode-screen" class="overlay-screen">
        <h1 style="color:var(--accent);">Ê≠¥Âè≤Âπ¥Âè∑„ÉªÁúüÂâ£ÂãùË≤†</h1>
        <button class="select-btn full-width main-menu-btn" onclick="selectMode('battle')">‚öîÔ∏è ‰æç„Éê„Éà„É´</button>
        <div style="height:20px;"></div>
        <button class="select-btn full-width main-menu-btn" onclick="selectMode('flash')">üé¥ ÊöóË®ò‰øÆË°å</button>
    </div>

    <div id="era-screen" class="overlay-screen hidden">
        <h2 style="color:var(--accent);">ÊôÇ‰ª£„ÇíÈÅ∏Êäû„Åõ„Çà</h2>
        <div class="btn-grid">
            <button class="select-btn full-width" onclick="selectEra('all')">ÂÖ®ÊôÇ‰ª£</button>
            <button class="select-btn" onclick="selectEra('Âè§‰ª£')">Âè§‰ª£</button>
            <button class="select-btn" onclick="selectEra('‰∏≠‰∏ñ')">‰∏≠‰∏ñ</button>
            <button class="select-btn" onclick="selectEra('Ëøë‰∏ñ')">Ëøë‰∏ñ</button>
            <button class="select-btn" onclick="selectEra('Ëøë‰ª£')">Ëøë‰ª£</button>
            <button class="select-btn full-width" onclick="selectEra('Áèæ‰ª£')">Áèæ‰ª£</button>
        </div>
    </div>

    <div id="diff-screen" class="overlay-screen hidden">
        <h2 style="color:var(--accent);">Èõ£ÊòìÂ∫¶„ÇíÈÅ∏Êäû„Åõ„Çà</h2>
        <div class="btn-grid">
            <button class="select-btn full-width" onclick="startBattle(1)">ÂàùÁ¥ö</button>
            <button class="select-btn full-width" onclick="startBattle(2)">‰∏≠Á¥ö</button>
            <button class="select-btn full-width" onclick="startBattle(3)">‰∏äÁ¥ö</button>
        </div>
    </div>

    <div id="game-ui" class="hidden" style="height:100%; display:flex; flex-direction:column;">
        <div class="status-bar">
            <div class="hp-container"><div class="hp-bar"><div id="p-hp" class="hp-fill"></div></div></div>
            <div class="hp-container"><div class="hp-bar"><div id="e-hp" class="hp-fill"></div></div></div>
        </div>
        <div id="battle-stage"><div id="slash"></div><div id="enemy-samurai"></div></div>
        <div class="ui-mid">
            <div id="timer-gauge"><div id="timer-fill"></div></div>
            <div id="event-name">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
            <div id="input-display">____</div>
        </div>
        <div class="keypad">
            <button class="key" onclick="tapNum(1)">1</button><button class="key" onclick="tapNum(2)">2</button><button class="key" onclick="tapNum(3)">3</button>
            <button class="key" onclick="tapNum(4)">4</button><button class="key" onclick="tapNum(5)">5</button><button class="key" onclick="tapNum(6)">6</button>
            <button class="key" onclick="tapNum(7)">7</button><button class="key" onclick="tapNum(8)">8</button><button class="key" onclick="tapNum(9)">9</button>
            <button class="key" onclick="tapClear()">Ê∂à</button><button class="key" onclick="tapNum(0)">0</button><button class="key" onclick="tapOk()">Êñ¨</button>
        </div>
    </div>

    <div id="flash-ui" class="overlay-screen hidden">
        <div id="fc-card" onclick="nextFcStep()">
            <p id="fc-year">----</p>
            <div id="fc-goro" class="hidden" style="color:red; font-weight:bold; margin:10px 0;"></div>
            <div id="fc-event" class="hidden" style="font-size:1.2rem;"></div>
        </div>
        <button class="select-btn" style="margin-top:20px;" onclick="location.reload()">Êàª„Çã</button>
    </div>

    <div id="result-screen" class="overlay-screen hidden">
        <h1 id="res-title"></h1>
        <button class="select-btn main-menu-btn" onclick="location.reload()">Êàª„Çã</button>
    </div>
</div>

<script src="questions.js"></script>

<script>
    // ÊôÇ‰ª£Âå∫ÂàÜ„ÅÆÂÆöÁæ©
    const ERA_MAP = {
        'Âè§‰ª£': ['ÊóßÁü≥Âô®', 'Á∏ÑÊñá', 'Âº•Áîü', 'Âè§Â¢≥', 'È£õÈ≥•', 'Â•àËâØ', 'Âπ≥ÂÆâ'],
        '‰∏≠‰∏ñ': ['ÈéåÂÄâ', 'ÂçóÂåóÊúù', 'ÂÆ§Áî∫'],
        'Ëøë‰∏ñ': ['ÂÆâÂúüÊ°ÉÂ±±', 'Ê±üÊà∏'],
        'Ëøë‰ª£': ['ÊòéÊ≤ª', 'Â§ßÊ≠£', 'Êò≠ÂíåÔºàÊà¶ÂâçÔºâ'],
        'Áèæ‰ª£': ['Êò≠ÂíåÔºàÊà¶ÂæåÔºâ', 'Âπ≥Êàê', '‰ª§Âíå']
    };

    let mode = '', selectedEra = '', playerHp = 100, enemyHp = 100;
    let currentIdx = 0, quizList = [], userInput = "", timerInterval, fcStep = 0;

    // Èü≥Â£∞„Ç®„É©„ÉºÈò≤Ê≠¢Áî®„ÅÆÁ©∫Èñ¢Êï∞
    function playSound(se) {}

    function selectMode(m) {
        mode = m;
        document.getElementById('mode-screen').classList.add('hidden');
        document.getElementById('era-screen').classList.remove('hidden');
    }

    function selectEra(era) {
        selectedEra = era;
        document.getElementById('era-screen').classList.add('hidden');
        if (mode === 'battle') {
            document.getElementById('diff-screen').classList.remove('hidden');
        } else {
            startFlash();
        }
    }

    function getFilteredList() {
        if (selectedEra === 'all') return masterData;
        const subEras = ERA_MAP[selectedEra];
        // questions.js„ÅÆeraÂàó„Åå„ÄåÂè§‰ª£„Äç„Åù„ÅÆ„ÇÇ„ÅÆ„Åã„ÄÅË©≥Á¥∞Âå∫ÂàÜÔºàÂ•àËâØ„Å™„Å©Ôºâ„Å´Âê´„Åæ„Çå„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        return masterData.filter(q => q.era === selectedEra || subEras.includes(q.era));
    }

    function startBattle(diff) {
        document.getElementById('diff-screen').classList.add('hidden');
        document.getElementById('game-ui').classList.remove('hidden');
        
        let pool = getFilteredList();
        quizList = pool.filter(q => q.d === diff);
        if (quizList.length === 0) quizList = pool; // Èõ£ÊòìÂ∫¶„ÅßË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØ„Åù„ÅÆÊôÇ‰ª£„ÅÆÂÖ®Âïè
        
        quizList = quizList.sort(() => Math.random() - 0.5).slice(0, 10);
        if (quizList.length === 0) { alert("ÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"); location.reload(); return; }
        
        currentIdx = 0; playerHp = 100; enemyHp = 100;
        showQuestion();
    }

    function showQuestion() {
        if (playerHp <= 0 || enemyHp <= 0 || currentIdx >= quizList.length) { endGame(); return; }
        userInput = ""; renderInput();
        document.getElementById('event-name').innerText = quizList[currentIdx].e;
        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        let start = Date.now();
        timerInterval = setInterval(() => {
            let ratio = 1 - ((Date.now() - start) / 12000);
            document.getElementById('timer-fill').style.width = Math.max(0, ratio * 100) + "%";
            if (ratio <= 0) { clearInterval(timerInterval); processResult(false); }
        }, 50);
    }

    function tapNum(n) { if (userInput.length < 4) { userInput += n; renderInput(); } }
    function tapClear() { userInput = ""; renderInput(); }
    function renderInput() { document.getElementById('input-display').innerText = userInput || "____"; }

    function tapOk() { 
        if (userInput === "") return; 
        clearInterval(timerInterval); 
        processResult(userInput === quizList[currentIdx].y); 
    }

    function processResult(correct) {
        const slash = document.getElementById('slash');
        if (correct) {
            slash.classList.remove('slash-anim'); void slash.offsetWidth; slash.classList.add('slash-anim');
            enemyHp -= 20;
        } else {
            playerHp -= 25;
            alert("Ê≠£Ëß£„ÅØ " + quizList[currentIdx].y + " Âπ¥„Åß„Åó„Åü");
        }
        document.getElementById('p-hp').style.width = playerHp + "%";
        document.getElementById('e-hp').style.width = enemyHp + "%";
        setTimeout(() => { currentIdx++; showQuestion(); }, 800);
    }

    function endGame() {
        document.getElementById('game-ui').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('res-title').innerText = enemyHp <= 0 ? "ÂãùÂà©ÔºÅ" : "ÊïóÂåó...";
    }

    function startFlash() {
        quizList = getFilteredList().sort(() => Math.random() - 0.5);
        if (quizList.length === 0) { alert("„Éá„Éº„Çø„Å™„Åó"); location.reload(); return; }
        document.getElementById('flash-ui').classList.remove('hidden');
        currentIdx = 0; showFcCard();
    }

    function showFcCard() {
        fcStep = 0;
        const q = quizList[currentIdx];
        document.getElementById('fc-year').innerText = q.y;
        document.getElementById('fc-goro').innerText = q.h;
        document.getElementById('fc-event').innerText = q.e;
        document.getElementById('fc-goro').classList.add('hidden');
        document.getElementById('fc-event').classList.add('hidden');
    }

    function nextFcStep() {
        fcStep++;
        if (fcStep === 1) document.getElementById('fc-goro').classList.remove('hidden');
        else if (fcStep === 2) document.getElementById('fc-event').classList.remove('hidden');
        else { currentIdx++; if (currentIdx < quizList.length) showFcCard(); else location.reload(); }
    }
</script>
</body>
</html>